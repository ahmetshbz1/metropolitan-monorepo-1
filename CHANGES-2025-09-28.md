# Deployment Changes – 2025-09-28

Bu doküman, 2025-09-28 tarihinde backend ve altyapıda yapılan değişikliklerin ve operasyonların özetidir. Kod değişiklikleri önce `main` dalına uygulanmış, ardından `prod` ile senkronize edilmiştir.

## Özet
- Auth: Sosyal hesap bağlama (Apple/Google) akışı, Authorization header ile link modunda çalışacak şekilde iyileştirildi.
- API: Ürün görselleri için mutlak URL üretimi, proxy (nginx) arkasında X-Forwarded-Proto/Host ile düzeltildi.
- Seed: Alerjen ve saklama koşulu çevirileri ana seed’e taşındı (tek komutla tüm seed).
- Drizzle generate: `drizzle-kit` artık `bunx` ile çağırılıyor.
- Docker build: Image içine `.env` kopyalama ve build-time `generate` kaldırıldı; yalnızca runtime env (docker-compose) kullanılıyor.
- Operasyon: Sunucuda Docker tamamen temizlendi, env güncellendi, yeniden deploy edildi; migrate ve seed başarıyla çalıştı.
- Temizlik: İstenen şekilde sunucudaki tüm kullanıcı ve ilgili veriler (orders, cart, favorites, addresses vb.) temizlendi; Redis oturum/verileri flush edildi.

## Detaylı Değişiklikler (Kod)

### 1) Sosyal Hesap Bağlama
- Dosya: `packages/backend/src/domains/identity/presentation/routes/social-auth.routes.ts`
- Değişiklik:
  - `Authorization: Bearer <accessToken>` varsa endpoint “link” modunda çalışır.
  - Mevcut oturumdaki kullanıcıya (access token’daki `sub`) sosyal hesap bağlanır.
  - Apple (`appleUserId`) / Google (`firebaseUid`) çakışma kontrolü eklenmiştir.
  - Başarılı bağlama sonrası access/refresh token yenilenir.
- Neden: OTP ile giriş yaptıktan sonra sosyal hesap bağlandığında “misafir” gibi algılanma sorununu önlemek.

### 2) Görsel URL’leri
- Dosyalar:
  - `packages/backend/src/domains/catalog/presentation/routes/products.routes.ts`
  - `packages/backend/src/domains/content/presentation/routes/guest-favorites.routes.ts`
  - `packages/backend/src/domains/content/presentation/routes/guest-cart.routes.ts`
- Değişiklik: Base URL artık `X-Forwarded-Proto` ve `Host` ile türetiliyor; aksi halde `request.url` origin kullanılır.
- Neden: Nginx/Cloudflare arkasındaki isteklerde doğru mutlak görsel URL’si üretmek.

### 3) Seed Konsolidasyonu
- Dosya: `packages/backend/src/shared/infrastructure/database/seed.ts`
- Değişiklik: 
  - `allergen_translations` ve `storage_condition_translations` seed’i ana seed’e taşındı.
  - Artık tek komutla (`bun run db:seed`) tüm sözlük ve ürün/kategori verisi yüklenir.
- Neden: Boş çeviri tabloları yüzünden ürün listesinde lookup hatalarının önüne geçmek ve operasyonu sadeleştirmek.

### 4) Generate ve Docker İyileştirmeleri
- Dosya: `packages/backend/package.json`
  - `db:generate` → `bunx drizzle-kit generate`
- Dosya: `packages/backend/Dockerfile`
  - `.env` kopyalama ve build-time generate kaldırıldı (sadece runtime env).
- Neden: bun + drizzle-kit + dotenv build uyumsuzluklarını önlemek ve env karmaşasını azaltmak.

## Operasyonel Adımlar (Sunucu)
- `/opt/metropolitan.env` ve `/opt/metropolitan/.env` içerikleri lokal `sunucu.env` ile güncellendi.
- Docker tamamen temizlendi (containers/images/volumes/networks) ve yeniden ayağa kaldırıldı.
- `db:migrate` ve `db:seed` başarıyla çalıştı.
- Ürün görselleri `https://api.metropolitanfg.pl/images/<code>.png` ile erişilebilir durumda.
- İstenilen temizlik: PostgreSQL’de users ve bağlı tablolar TRUNCATE CASCADE ile boşaltıldı; Redis FLUSHALL ile temizlendi.

## Test Notları
- OTP ile giriş (örnek): `+48123456789` ve `555555` → başarılı.
- Sosyal bağlama: OTP login sonrası `/auth/social-signin` çağrısı **Authorization header ile** yapılmalıdır.
- Ürün listesi: `/api/products?lang=tr&page=1&limit=20` → `image` alanı mutlak URL döner.

## Bilinen Notlar
- `db:generate` üretimde zorunlu değil; yerelde `cd packages/backend && bun run db:generate` ile kullanılabilir.
- Sosyal bağlama için alternatif akış: Ayrı bir `/auth/social-link` endpoint’i açılabilir (tercihe bağlı, uygulanmadı).
